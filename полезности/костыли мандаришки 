1. закостылены сео фильтра - 
в инит пхп функция на онэпилог , подставляются проверкой на урл фильтр , 
свойства для фильтра задаются в пейдж проперти в компонент эпилоге в каталог секшне гетлистом из хайлодблока 


------------------------------------------------------------
инит пхп для сео (тут и пагинация , и новый шаблонизатор для элементов , и фильтр через хайлодблок )



новый модуль в рез модифайре каталог.элемента 

AddEventHandler("main", "OnEpilog", "changeMeta");
function changeMeta()
{
  global $APPLICATION;
  //тут было исправлено двойное отрицание != false
  if(strpos($_SERVER["REQUEST_URI"], '/hit.php') == false){

    if (!preg_match("#/new.php#", $_SERVER["REQUEST_URI"]))
    {

      if($APPLICATION->GetPageProperty("filter_title") && strpos($_SERVER['REQUEST_URI'], '/filter/'))
        $APPLICATION->SetPageProperty('title',$APPLICATION->GetPageProperty("filter_title"));


      if($APPLICATION->GetPageProperty("filter_description") && strpos($_SERVER['REQUEST_URI'], '/filter/'))
        $APPLICATION->SetPageProperty('description',$APPLICATION->GetPageProperty("filter_description"));
      if($APPLICATION->GetPageProperty("filter_keywords") && strpos($_SERVER['REQUEST_URI'], '/filter/'))
        $APPLICATION->SetPageProperty('keywords',$APPLICATION->GetPageProperty("filter_keywords"));

      /* element */
      if($APPLICATION->GetPageProperty("new_element_h1"))
        $APPLICATION->SetTitle($APPLICATION->GetPageProperty("new_element_h1"));


      if (isset($_GET['sort']) || isset($_GET['order']))
      {
        $APPLICATION->AddHeadString('<meta name="Googlebot" content="noindex, follow"/>');
      }

    }
  }

  if(isset($_GET["PAGEN_1"])){
  $pagetitle=$APPLICATION->GetPageProperty("title");
  $pagepagintitle=$pagetitle.", страница ".$_GET["PAGEN_1"];
  //echo $pagepagintitle;
    $APPLICATION->SetPageProperty('title',$pagepagintitle);
  //echo $APPLICATION->GetPageProperty("filter_title");
  $pagedescr=$APPLICATION->GetPageProperty("description");
  $pagedescr2=$pagedescr.", страница ".$_GET["PAGEN_1"];
  //echo $pagepagintitle;
    $APPLICATION->SetPageProperty('description',$pagedescr2);
}

//пееписанное сео для элементов в разделе (новыйе аольз свойства элементов или польз поля разделов , приходят из резалт модифайра каталог элемент)
if($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOTITLE"))
  $APPLICATION->SetPageProperty('title',htmlspecialchars_decode(strip_tags($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOTITLE"))));
if($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEODESCRIPTION"))
    $APPLICATION->SetPageProperty('description',htmlspecialchars_decode(strip_tags($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEODESCRIPTION"))));
if($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOKEYWORDS")){
$arResrsesrsrr=strtolower(htmlspecialchars_decode(strip_tags($APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOKEYWORDS"))));
$test = str_replace(array('?','!',',',';','"','-'), "", $arResrsesrsrr);
  $APPLICATION->SetPageProperty('keywords',$test);}


}



















а тут у нас новый модуль сео с шаблонизатором для элементов 








//print_r($arSect2);
//ПРОВЕРЯЕМ СУЩЕСТВОВАНИЕ ПОЛЬЗ СВОЙСТВ СЕО
if(!empty($arResult["PROPERTIES"]["SEO_TITLE"]["VALUE"])){
$SEOPROPTITLE=$arResult["PROPERTIES"]["SEO_TITLE"]["VALUE"];
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOTITLE",$SEOPROPTITLE);
//echo $SEOPROPTITLE;
}else{
  if (!empty($arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"])){

  $ParentCode=$arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"];
    //echo $ParentCode;
  $IBLOCK_ID="2";
    $arFilter2 = array('IBLOCK_ID' =>"2","CODE"=>$ParentCode);
  $arFields2=array("UF_SEOTITLEELEMSHABL", "NAME", "IBLOCK_SECTION_ID");
       $rsSect2 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter2,false,$arFields2);
       while ($arSect = $rsSect2->GetNext())
       {
           $arSect2[]=$arSect;
       }

       if (empty($arSect2["0"]["UF_SEOTITLEELEMSHABL"])){
$granParent=$arSect2["0"]["IBLOCK_SECTION_ID"];
         $arFilter3 = array('IBLOCK_ID' =>"2","ID"=>$granParent);
       $arFields3=array("UF_SEOTITLEELEMSHABL", "NAME", "IBLOCK_SECTION_ID");
            $rsSect3 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter3,false,$arFields3);
            while ($arSect3 = $rsSect3->GetNext())
            {
                $arSect4[]=$arSect3;
            }

//print_r($arSect4);
if(!empty($arSect4["0"]["UF_SEOTITLEELEMSHABL"])){
$TITLEPARENT=$arSect4["0"]["UF_SEOTITLEELEMSHABL"];
}

}elseif(!empty($arSect2["0"]["UF_SEOTITLEELEMSHABL"])) {
$TITLEPARENT=$arSect2["0"]["UF_SEOTITLEELEMSHABL"];
    }




if(!empty($TITLEPARENT)) //что то ДАЛЬШЕ ОБРАБАТЫВАЕМ РЕЗУЛЬТАТ ВЫБОРКИ
   {

$TITLEFROMRAZDEL=$TITLEPARENT;//pfvtybnm
//$TITLEFROMRAZDELGOTOVIY = str_replace("{name}", "имя", $TITLEFROMRAZDEL);
//echo $TITLEFROMRAZDELGOTOVIY;

$mystring = $TITLEFROMRAZDEL;
$findme   = '{';
$pos = strpos($mystring, $findme);

// Заметьте, что используется ===.  Использование == не даст верного
// результата, так как 'a' в нулевой позиции.
if ($pos === false) {

                                                                               //СюДА ДОПИСАТЬ что делать ,  ЕСЛИ НЕТ {}
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOTITLE",$TITLEFROMRAZDEL);


}else{


  preg_match_all('~{([^}]+)}~i', $TITLEFROMRAZDEL, $matches);

  //print_r($arResult);

   foreach ($matches["1"] as $key) {
     //echo $key;
    if($key=="name"){
      //echo $key;
      $arRep=$arResult["NAME"];
      //echo $arRep;
      foreach ($matches["0"] as $key2) {

        $chetchik=substr($key2, 1);
        $chetchik2=substr("$chetchik", 0, -1);
          //echo $key;
        if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
        }

      }
}elseif($key=="price"){
  //echo $key;
  $arRep=$arResult["PRICES"]["BASE"]["PRINT_DISCOUNT_VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {

    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }

  }
}else{
  $arRep=$arResult["PROPERTIES"][$key]["VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {
    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){
$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }
  }
}
  }

$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOTITLE",$TITLEFROMRAZDEL);

}


  };
  };

};



//для дескрипшна

if(!empty($arResult["PROPERTIES"]["SEO_META_DESCRIPTION"]["VALUE"])){
$SEOPROPDESCRIPTION=$arResult["PROPERTIES"]["SEO_META_DESCRIPTION"]["VALUE"];
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEODESCRIPTION",$SEOPROPDESCRIPTION);


}else{
  if (!empty($arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"])){

  $ParentCode=$arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"];
  //  echo $ParentCode;
  $IBLOCK_ID="2";
    $arFilter222 = array('IBLOCK_ID' =>"2","CODE"=>$ParentCode);
  $arFields222=array("UF_SEODESCELEMSHABL", "NAME","IBLOCK_SECTION_ID");
       $rsSect9 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter222,false,$arFields222);
       while ($arSect9 = $rsSect9->GetNext())
       {
           $arSect10[]=$arSect9;
       }
    //  print_r($arSect10);
//        if (!empty($arSect3["0"]["UF_SEODESCELEMSHABL"])){
//
//
// $TITLEFROMRAZDEL=$arSect3["0"]["UF_SEODESCELEMSHABL"];
// //$TITLEFROMRAZDELGOTOVIY = str_replace("{name}", "имя", $TITLEFROMRAZDEL);
// //echo $TITLEFROMRAZDELGOTOVIY;
if (empty($arSect10["0"]["UF_SEODESCELEMSHABL"])){
$granParent=$arSect10["0"]["IBLOCK_SECTION_ID"];
  $arFilter9 = array('IBLOCK_ID' =>"2","ID"=>$granParent);
$arFields9=array("UF_SEODESCELEMSHABL", "NAME", "IBLOCK_SECTION_ID");
     $rsSect5 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter9,false,$arFields9);
     while ($arSect5 = $rsSect5->GetNext())
     {
         $arSect6[]=$arSect5;
     }

//print_r($arSect6);
if(!empty($arSect6["0"]["UF_SEODESCELEMSHABL"])){
$DESCPARENT=$arSect6["0"]["UF_SEODESCELEMSHABL"];
}

}elseif(!empty($arSect10["0"]["UF_SEODESCELEMSHABL"])) {
$DESCPARENT=$arSect10["0"]["UF_SEODESCELEMSHABL"];
}




if(!empty($DESCPARENT)) //что то ДАЛЬШЕ ОБРАБАТЫВАЕМ РЕЗУЛЬТАТ ВЫБОРКИ
{

$TITLEFROMRAZDEL=$DESCPARENT;//pfvtybnm
$mystring = $TITLEFROMRAZDEL;
$findme   = '{';
$pos = strpos($mystring, $findme);

// Заметьте, что используется ===.  Использование == не даст верного
// результата, так как 'a' в нулевой позиции.
if ($pos === false) {

                                                                               //СюДА ДОПИСАТЬ что делать ,  ЕСЛИ НЕТ {}
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEODESCRIPTION",$TITLEFROMRAZDEL);


}else{


  preg_match_all('~{([^}]+)}~i', $TITLEFROMRAZDEL, $matches);

  //print_r($arResult);

   foreach ($matches["1"] as $key) {
     //echo $key;
    if($key=="name"){
      //echo $key;
      $arRep=$arResult["NAME"];
      //echo $arRep;
      foreach ($matches["0"] as $key2) {

        $chetchik=substr($key2, 1);
        $chetchik2=substr("$chetchik", 0, -1);
          //echo $key;
        if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
        }

      }
}elseif($key=="price"){
  //echo $key;
  $arRep=$arResult["PRICES"]["BASE"]["PRINT_DISCOUNT_VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {

    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }

  }
}else{
  $arRep=$arResult["PROPERTIES"][$key]["VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {
    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){
$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }
  }
}
  }

$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEODESCRIPTION",$TITLEFROMRAZDEL);

}


  };
  };

};
//KEYWORDS
if(!empty($arResult["PROPERTIES"]["SEO_KEYWORDS"]["VALUE"])){
$SEOPROPKEYWORDS=$arResult["PROPERTIES"]["SEO_KEYWORDS"]["VALUE"];
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOKEYWORDS",$SEOPROPKEYWORDS);
}else{
  if (!empty($arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"])){

  $ParentCode=$arResult["ORIGINAL_PARAMETERS"]["SECTION_CODE"];
    //echo $ParentCode;
  $IBLOCK_ID="2";
    $arFilter2 = array('IBLOCK_ID' =>"2","CODE"=>$ParentCode);
  $arFields7=array("UF_SEOKEYELEMSHABL", "NAME");
       $rsSect7 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter2,false,$arFields2);
       while ($arSect123 = $rsSect7->GetNext())
       {
           $arSect4[]=$arSect123;
       }
      // print_r($arSect2);
//        if (!empty($arSect4["0"]["UF_SEOKEYELEMSHABL"])){
//
//
// $TITLEFROMRAZDEL=$arSect4["0"]["UF_SEOKEYELEMSHABL"];
// //$TITLEFROMRAZDELGOTOVIY = str_replace("{name}", "имя", $TITLEFROMRAZDEL);
// //echo $TITLEFROMRAZDELGOTOVIY;
if (empty($arSect4["0"]["UF_SEOKEYELEMSHABL"])){
$granParent=$arSect4["0"]["IBLOCK_SECTION_ID"];
  $arFilter8 = array('IBLOCK_ID' =>"2","ID"=>$granParent);
$arFields8=array("UF_SEOKEYELEMSHABL", "NAME", "IBLOCK_SECTION_ID");
     $rsSect3 = CIBlockSection::GetList(array('left_margin' => 'asc'),$arFilter8,false,$arFields8);
     while ($arSect31 = $rsSect3->GetNext())
     {
         $arSect7[]=$arSect31;
     }

//print_r($arSect7);
if(!empty($arSect7["0"]["UF_SEOKEYELEMSHABL"])){
$KEYPARENT=$arSect7["0"]["UF_SEOKEYELEMSHABL"];
}

}elseif(!empty($arSect4["0"]["UF_SEOKEYELEMSHABL"])) {
$KEYPARENT=$arSect4["0"]["UF_SEOKEYELEMSHABL"];
}




if(!empty($KEYPARENT)) //что то ДАЛЬШЕ ОБРАБАТЫВАЕМ РЕЗУЛЬТАТ ВЫБОРКИ
{

$TITLEFROMRAZDEL=$KEYPARENT;//pfvtybnm
$mystring = $TITLEFROMRAZDEL;
$findme   = '{';
$pos = strpos($mystring, $findme);

// Заметьте, что используется ===.  Использование == не даст верного
// результата, так как 'a' в нулевой позиции.
if ($pos === false) {

                                                                               //СюДА ДОПИСАТЬ что делать ,  ЕСЛИ НЕТ {}
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOKEYWORDS",$TITLEFROMRAZDEL);


}else{


  preg_match_all('~{([^}]+)}~i', $TITLEFROMRAZDEL, $matches);

  //print_r($arResult);

   foreach ($matches["1"] as $key) {
     //echo $key;
    if($key=="name"){
      //echo $key;
      $arRep=$arResult["NAME"];
      //echo $arRep;
      foreach ($matches["0"] as $key2) {

        $chetchik=substr($key2, 1);
        $chetchik2=substr("$chetchik", 0, -1);
          //echo $key;
        if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
        }

      }
}elseif($key=="price"){
  //echo $key;
  $arRep=$arResult["PRICES"]["BASE"]["PRINT_DISCOUNT_VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {

    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){

$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }

  }
}else{
  $arRep=$arResult["PROPERTIES"][$key]["VALUE"];
  //echo $arRep;
  foreach ($matches["0"] as $key2) {
    $chetchik=substr($key2, 1);
    $chetchik2=substr("$chetchik", 0, -1);
      //echo $key;
    if($chetchik2==$key){
$TITLEFROMRAZDEL = str_replace($key2, $arRep, $TITLEFROMRAZDEL);
    }
  }
}
  }
  $str = mb_convert_case($TITLEFROMRAZDEL, MB_CASE_LOWER , 'Windows-1251');
$APPLICATION->SetPageProperty("ELEMENTfromRazdelSEOKEYWORDS",$str);

}


  };
  };

};
// echo $APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOTITLE");
// echo $APPLICATION->GetPageProperty("ELEMENTfromRazdelSEODESCRIPTION");
// echo $APPLICATION->GetPageProperty("ELEMENTfromRazdelSEOKEYWORDS");
// echo $APPLICATION->SetPageProperty("description","ELEMENTfromRazdelSEOTITLE");
// // echo "123123123123123123123";


















<?php
/** @var array $arParams */
/** @var array $arResult */
/** @global CMain $APPLICATION */
/** @global CUser $USER */
/** @global CDatabase $DB */
/** @var CBitrixComponentTemplate $this */
/** @var string $templateName */
/** @var string $templateFile */
/** @var string $templateFolder */
/** @var string $componentPath */
/** @var CBitrixComponent $component */
if (!defined("B_PROLOG_INCLUDED") || B_PROLOG_INCLUDED !== true) {
    die();
}

use Bitrix\Main\Loader;
use Bitrix\Main\ModuleManager;

$registry = \Gt\Registry\Application::getInstance();
$this->setFrameMode(true);
global ${$arParams["FILTER_NAME"]};

$APPLICATION->SetPageProperty('NOT_SHOW_TITLE', 'Y');


$arParams['USE_FILTER'] = (isset($arParams['USE_FILTER']) && $arParams['USE_FILTER'] == 'Y' ? 'Y' : 'N');

if ($arParams["USE_COMPARE"] == "Y") {
    ?><?
    $APPLICATION->IncludeComponent(
        "bitrix:catalog.compare.list",
        "",
        array(
            "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
            "IBLOCK_ID" => $arParams["IBLOCK_ID"],
            "NAME" => $arParams["COMPARE_NAME"],
            "DETAIL_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["element"],
            "COMPARE_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["compare"],
            "ACTION_VARIABLE" => $arParams["ACTION_VARIABLE"],
            "PRODUCT_ID_VARIABLE" => $arParams["PRODUCT_ID_VARIABLE"],
            'POSITION_FIXED' => isset($arParams['COMPARE_POSITION_FIXED']) ? $arParams['COMPARE_POSITION_FIXED'] : '',
            'POSITION' => isset($arParams['COMPARE_POSITION']) ? $arParams['COMPARE_POSITION'] : ''
        ),
        $component,
        array("HIDE_ICONS" => "Y")
    ); ?><?
}

if (isset($arParams['USE_COMMON_SETTINGS_BASKET_POPUP']) && $arParams['USE_COMMON_SETTINGS_BASKET_POPUP'] == 'Y') {
    $basketAction = (isset($arParams['COMMON_ADD_TO_BASKET_ACTION']) ? $arParams['COMMON_ADD_TO_BASKET_ACTION'] : '');
} else {
    $basketAction = (isset($arParams['SECTION_ADD_TO_BASKET_ACTION']) ? $arParams['SECTION_ADD_TO_BASKET_ACTION'] : '');
}
$intSectionID = 0;
?>

<? $menu_sections = $APPLICATION->IncludeComponent(
    "gt:menu.sections.virtyal.section",
    "",
    array(
        "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
        "VIRTYAL_IBLOCK_ID" => VIRTUAL_SECTION_IBLOCK_ID,
        "IBLOCK_ID" => $arParams["IBLOCK_ID"],
        "CACHE_TYPE" => $arParams["CACHE_TYPE"],
        "CACHE_TIME" => $arParams["CACHE_TIME"],
        'VIRTYAL_COD' => $arResult["VARIABLES"]["VIRTYAL"],
        'SEC_CODE' => $arResult["VARIABLES"]["SECTION_CODE"],
    ),
    false
);
if ($arResult["VARIABLES"]["VIRTYAL"]) {
    if ($arResult["VARIABLES"]["VIRTYAL"] != "seks-igrushki" && $arResult["VARIABLES"]["VIRTYAL"] != "intimnaya-kosmetika-smazki" && $arResult["VARIABLES"]["VIRTYAL"] != "afrodiziaki" && $arResult["VARIABLES"]["VIRTYAL"] != "fetish-i-bdsm" && $arResult["VARIABLES"]["VIRTYAL"] != "bele-odezhda") {
        \Bitrix\Iblock\Component\Tools::process404(
            ""
            , ($arParams["SET_STATUS_404"] === "Y")
            , ($arParams["SET_STATUS_404"] === "Y")
            , ($arParams["SHOW_404"] === "Y")
            , $arParams["FILE_404"]
        );
    }
}

//print_r($menu_sections);
$sectID = getIdByCode($arResult["VARIABLES"]["SECTION_CODE"], $arParams["IBLOCK_ID"], "IBLOCK_SECTION");
$arFilter = Array('IBLOCK_ID' => $arParams['IBLOCK_ID'], 'ID' => $sectID, 'GLOBAL_ACTIVE' => 'Y');
$db_list = CIBlockSection::GetList(Array("timestamp_x" => "DESC"), $arFilter, false,
    Array("UF_SEO_H1", "UF_DESCRIPTION", "UF_METKI"));
if ($uf_value = $db_list->GetNext()) {
    $h1 = $uf_value["UF_SEO_H1"];
    $APPLICATION->SetTitle($h1);
}

?>

<div class="catalog_wrap cf">

    <div class="catalog_filter">

        <? if (!empty($menu_sections['SECTIONS'])): ?>
            <ul class="catalog_menu">
                <? foreach ($menu_sections['SECTIONS'] as $v): ?>
                    <? if (empty($v['SUBSEC'])): ?>
                        <li class="<? if ($v['ACTIV']): ?> activ_parent <? endif ?> dop_men" >
                            <a <? if ($v['ACTIV']): ?>rel="nofollow"
                               <? endif ?>href="<?= $v['SECTION_PAGE_URL'] ?>" ><?= $v['NAME'] ?></a></li>
                    <? else: ?>
                        <li class=" <? if ($v['ACTIV']): ?> activ_parent <? endif ?> parent">
                            <a <? if ($v['ACTIV']): ?>rel="nofollow"
                               <? endif ?>href="<?= $v['SECTION_PAGE_URL'] ?>" class="gulac gulac3"><?= $v['NAME'] ?><i
                                        class="before_sub_menu_title"></i></a>
                            <ul>
                                <? foreach ($v['SUBSEC'] as $w): ?>
                                    <li <? if ($w['ACTIV']): ?> class="activ" <? endif ?> >
                                        <a <? if ($w['ACTIV']): ?>rel="nofollow"
                                           <? endif ?>href="<?= $w['SECTION_PAGE_URL'] ?>"><?= $w['NAME'] ?></a></li>
                                <? endforeach ?>
                            </ul>
                        </li>
                    <? endif; ?>
                <? endforeach ?>
            </ul>
        <? endif ?>
        <?
        if ($arParams['USE_FILTER'] == 'Y') {
            $arFilter = array(
                "IBLOCK_ID" => $arParams["IBLOCK_ID"],
                "ACTIVE" => "Y",
                "GLOBAL_ACTIVE" => "Y",
            );
            if (0 < intval($arResult["VARIABLES"]["SECTION_ID"])) {
                $arFilter["ID"] = $arResult["VARIABLES"]["SECTION_ID"];
            } elseif ('' != $arResult["VARIABLES"]["SECTION_CODE"]) {
                $arFilter["=CODE"] = $arResult["VARIABLES"]["SECTION_CODE"];
            }

            $obCache = new CPHPCache();
            if ($obCache->InitCache(36000, serialize($arFilter), "/iblock/catalog")) {
                $arCurSection = $obCache->GetVars();
            } elseif ($obCache->StartDataCache()) {
                $arCurSection = array();
                if (Loader::includeModule("iblock")) {
                    $dbRes = CIBlockSection::GetList(array(), $arFilter, false, array("ID"));

                    if (defined("BX_COMP_MANAGED_CACHE")) {
                        global $CACHE_MANAGER;
                        $CACHE_MANAGER->StartTagCache("/iblock/catalog");

                        if ($arCurSection = $dbRes->Fetch()) {
                            $CACHE_MANAGER->RegisterTag("iblock_id_" . $arParams["IBLOCK_ID"]);
                        }
                        $CACHE_MANAGER->EndTagCache();
                    } else {
                        if (!$arCurSection = $dbRes->Fetch()) {
                            $arCurSection = array();
                        }
                    }
                }
                $obCache->EndDataCache($arCurSection);
            }
            if (!isset($arCurSection)) {
                $arCurSection = array();
            } ?>

            <?
            $stores = $registry->getResource('CITY_STORES');
            $price_type = $registry->getResource('CITY_PRICE_TYPE_ID');
            $APPLICATION->IncludeComponent(
                "gt:catalog.smart.filter",
                "left",
                array(
                    "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
                    "IBLOCK_ID" => $arParams["IBLOCK_ID"],
                    "SECTION_ID" => array($arCurSection['ID']),
                    "FILTER_NAME" => $arParams["FILTER_NAME"],
                    "PRICE_CODE" => $arParams["PRICE_CODE"],
                    "CACHE_TYPE" => $arParams["CACHE_TYPE"],
                    "CACHE_TIME" => $arParams["CACHE_TIME"],
                    "CACHE_GROUPS" => $arParams["CACHE_GROUPS"],
                    "SAVE_IN_SESSION" => "N",
                    "FILTER_VIEW_MODE" => $arParams["FILTER_VIEW_MODE"],
                    "XML_EXPORT" => "Y",
                    "SECTION_TITLE" => "NAME",
                    "SECTION_DESCRIPTION" => "DESCRIPTION",
                    'HIDE_NOT_AVAILABLE' => $arParams["HIDE_NOT_AVAILABLE"],
                    "TEMPLATE_THEME" => $arParams["TEMPLATE_THEME"],
                    'STORES_ID' => $stores,
                    /*Ид склада для которого показывать свойства товаров которые есть в наличии на этом складе может быть массивом*/
                    'PRICE_TYPE_ID' => $price_type,
                    /*Ид типа цены*/
                ),
                $component,
                array('HIDE_ICONS' => 'Y')
            );

            $APPLICATION->IncludeComponent(
                "sotbit:seo.meta",
                ".default",
                Array(
                    "FILTER_NAME" => $arParams["FILTER_NAME"],
                    "SECTION_ID" => $arCurSection['ID'],
                    "CACHE_TYPE" => $arParams["CACHE_TYPE"],
                    "CACHE_TIME" => $arParams["CACHE_TIME"],
                )
            );
?>
<?

        }
        ?>
        <style type="text/css">
        	.recent_wrap ul.recent_list  .button.js-add-to-cart.add2bas  {
        		width: 85px;
        	}
        	.recent_wrap ul.recent_list  .button.in-cart  {
        		width: 85px;
        	}
        	.recent_wrap ul.recent_list.recent-ex-pro .price_s2  {
        		font: bold 12px/12px arvo;
        		padding: 8px 4px 2px 8px;
        	}
        	.recent_wrap ul.recent_list  .product_price_old  {
        		display: none;
        	}
        	.recent_wrap ul.recent_list  .cat_prod_compare {
        		display: none;
        	}
        	.recent_wrap ul.recent_list li {
        		min-height: 170px;
        		height: auto!important;
        	}
        </style>
        <div class="recent_wrap">
            <? $APPLICATION->IncludeComponent(
                'bitrix:catalog.viewed.products',
                '',
                Array(
                    'IBLOCK_TYPE' => $arParams['IBLOCK_TYPE'],
                    'IBLOCK_ID' => $arParams['IBLOCK_ID'],
                    'SHOW_FROM_SECTION' => 'N',
                    'SECTION_ID' => '',
                    'SECTION_CODE' => '',
                    'SECTION_ELEMENT_ID' => '',
                    'SECTION_ELEMENT_CODE' => '',
                    'DEPTH' => '',
                    'HIDE_NOT_AVAILABLE' => $arParams['HIDE_NOT_AVAILABLE'],
                    'SHOW_DISCOUNT_PERCENT' => 'N',
                    'PRODUCT_SUBSCRIPTION' => $arParams['PRODUCT_SUBSCRIPTION'],
                    'SHOW_NAME' => 'N',
                    'SHOW_IMAGE' => 'N',
                    'MESS_BTN_BUY' => '',
                    'MESS_BTN_DETAIL' => '',
                    'MESS_BTN_SUBSCRIBE' => '',
                    'PAGE_ELEMENT_COUNT' => '4',
                    'LINE_ELEMENT_COUNT' => '1',
                    'TEMPLATE_THEME' => '',
                    'DETAIL_URL' => $arResult['FOLDER'] . $arResult['URL_TEMPLATES']['element'],
                    'CACHE_TYPE' => $arParams['CACHE_TYPE'],
                    'CACHE_TIME' => $arParams['CACHE_TIME'],
                    'CACHE_GROUPS' => $arParams['CACHE_GROUPS'],
                    'SHOW_OLD_PRICE' => 'N',
                    'PRICE_CODE' => $arParams['PRICE_CODE'],
                    'SHOW_PRICE_COUNT' => '1',
                    'PRICE_VAT_INCLUDE' => $arParams['PRICE_VAT_INCLUDE'],
                    'CONVERT_CURRENCY' => $arParams['CONVERT_CURRENCY'],
                    'BASKET_URL' => $arParams['BASKET_URL'],
                    'ACTION_VARIABLE' => $arParams['ACTION_VARIABLE'],
                    'PRODUCT_ID_VARIABLE' => $arParams['PRODUCT_ID_VARIABLE'],
                    'PRODUCT_QUANTITY_VARIABLE' => $arParams['PRODUCT_QUANTITY_VARIABLE'],
                    'ADD_PROPERTIES_TO_BASKET' => (isset($arParams['ADD_PROPERTIES_TO_BASKET']) ? $arParams['ADD_PROPERTIES_TO_BASKET'] : ''),
                    //'PRODUCT_PROPS_VARIABLE' => $arParams['PRODUCT_PROPS_VARIABLE'],
                    //'PARTIAL_PRODUCT_PROPERTIES' => (isset($arParams['PARTIAL_PRODUCT_PROPERTIES']) ? $arParams['PARTIAL_PRODUCT_PROPERTIES'] : ''),
                    'USE_PRODUCT_QUANTITY' => $arParams['USE_PRODUCT_QUANTITY'],
                    'SHOW_PRODUCTS_' . $arParams['IBLOCK_ID'] => true,
                ),
                $component
            ); ?>
        </div>

    </div>

    <div class="over catalog_content">
        <? $APPLICATION->IncludeComponent(
            "bitrix:breadcrumb",
            "bred",
            Array(
                "START_FROM" => "0",
                "PATH" => "",
                "SITE_ID" => "s1"
            )
        ); ?>

<?

	global $sotbitSeoMetaH1;  
	if(!empty($sotbitSeoMetaH1)){
		$h1=$sotbitSeoMetaH1;
		 $APPLICATION->SetTitle($sotbitSeoMetaH1); 
	} 
?>
       
            <div class="heading"><!--start_content-->
                <h1><?
                    $APPLICATION->ShowTitle(false);
                ?></h1><!--end_content-->
            </div>

 <noindex>

            <div class="catalog_sort">


<script type="text/javascript">
    $(document).ready(function() {
        $('.page-count-select').change(function(){
            location.href = $(this).find(':selected').attr('rel');
        });
    });
</script>

<div class="page-count">
<!-- <div class="sPageTitle">Количество товаров на странице: </div> -->

<select class="page-count-select">
<? $arrCountPrd = array(36, 48, 64, 96); 
   foreach ($arrCountPrd as $key => $value) {
      if($_GET['page_count'] == $value) echo "<option rel='" . $page = $APPLICATION->GetCurPageParam("page_count=$value", array("page_count")) . "' selected> $value </option>";
      else echo "<option rel='" . $page = $APPLICATION->GetCurPageParam("page_count=$value", array("page_count")) . "'> $value </option>";
   }
  // if((int)$arResult["NAV_RESULT"]->nSelectedCount < 120) echo "<option rel='" . $page = $APPLICATION->GetCurPageParam("ELEMENT_COUNT=" . $arResult['NAV_RESULT']->nSelectedCount, array("ELEMENT_COUNT")) . "'>Все</option>"
?>
</select>

</div>



                <div class="search_num">
                    Товаров: <? $APPLICATION->ShowProperty('RECORD_COUNT'); ?>
                </div>

                <? $sort = $APPLICATION->IncludeComponent(
                    "gt:catalog.sort",
                    "",
                    array(
                        "SORT" => $_REQUEST["sort"],
                        "ORDER" => $_REQUEST["order"],
                    ),
                    false
                ); 

$APPLICATION->IncludeComponent(
   "sotbit:seo.meta.tags",
   ".default",
   Array(
     "CACHE_GROUPS" => $arParams["CACHE_GROUPS"],
     "CACHE_TIME" => $arParams["CACHE_TIME"],
     "CACHE_TYPE" => $arParams["CACHE_TYPE"],
     "CNT_TAGS" => "",
     "IBLOCK_ID" => $arParams["IBLOCK_ID"],
     "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
     "INCLUDE_SUBSECTIONS" => $arParams["INCLUDE_SUBSECTIONS"],
     "SECTION_ID" => $arCurSection['ID'],
     "SORT" => "CONDITIONS",
     "SORT_ORDER" => "desc",
     "COMPONENT_TEMPLATE" => ".default",
   )
);
?>
            </div>
        </noindex>
        <?

        if (!empty($arCurSection['ID'])) {

            global $filt_name_recomend;
//                $registry = \Gt\Registry\Application::getInstance();
//                $price_type=$registry->getResource('CITY_PRICE_TYPE_ID');
//                $stores=$registry->getResource('CITY_STORES');
//                $filt_name_recomend['>CATALOG_PRICE_'.$price_type] = 0;
//                $filt_name_recomend['SECTION_ACTIVE'] = 'Y';
//                $stor_filter=array(
//                    'LOGIC' => 'OR'
//                );
//                foreach($stores as $v){
//                    if(intval($v)>0){
//                        $stor_filter[]=array('>CATALOG_STORE_AMOUNT_'.$v=>0);
//                    }
//                }
//                if(count($stor_filter)>1){
//                    $filt_name_recomend[]=$stor_filter;
//                }
            $filt_name_recomend = \Gt\Helper\Data::GetCatalogFilter();
            //$filt_name_recomend['!PROPERTY_RECOMMENDED_FOR_SECTIONS']=false;
            $filt_name_recomend['PROPERTY_RECOMMENDED_FOR_SECTIONS'] = $arCurSection['ID'];

            $APPLICATION->IncludeComponent(
                "bitrix:catalog.section",
                "catalog_dop_recomend",
                array(
                    "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
                    "IBLOCK_ID" => $arParams["IBLOCK_ID"],
                    "ELEMENT_SORT_FIELD" => 'SORT',
                    "ELEMENT_SORT_ORDER" => 'asc',
                    "ELEMENT_SORT_FIELD2" => $arParams["ELEMENT_SORT_FIELD2"],
                    "ELEMENT_SORT_ORDER2" => $arParams["ELEMENT_SORT_ORDER2"],
                    "PROPERTY_CODE" => $arParams["LIST_PROPERTY_CODE"],
                    "META_KEYWORDS" => $arParams["LIST_META_KEYWORDS"],
                    "META_DESCRIPTION" => $arParams["LIST_META_DESCRIPTION"],
                    "BROWSER_TITLE" => $arParams["LIST_BROWSER_TITLE"],
                    "INCLUDE_SUBSECTIONS" => $arParams["INCLUDE_SUBSECTIONS"],
                    "BASKET_URL" => $arParams["BASKET_URL"],
                    "ACTION_VARIABLE" => $arParams["ACTION_VARIABLE"],
                    "PRODUCT_ID_VARIABLE" => $arParams["PRODUCT_ID_VARIABLE"],
                    "SECTION_ID_VARIABLE" => $arParams["SECTION_ID_VARIABLE"],
                    "PRODUCT_QUANTITY_VARIABLE" => $arParams["PRODUCT_QUANTITY_VARIABLE"],
                    "PRODUCT_PROPS_VARIABLE" => $arParams["PRODUCT_PROPS_VARIABLE"],
                    "FILTER_NAME" => 'filt_name_recomend',
                    "CACHE_TYPE" => $arParams["CACHE_TYPE"],
                    "CACHE_TIME" => $arParams["CACHE_TIME"],
                    "CACHE_FILTER" => 'Y',
                    "CACHE_GROUPS" => $arParams["CACHE_GROUPS"],
                    "SET_TITLE" => 'N',
                    "SET_STATUS_404" => 'N',
                    "DISPLAY_COMPARE" => $arParams["USE_COMPARE"],
                    "PAGE_ELEMENT_COUNT" => 50,
                    "LINE_ELEMENT_COUNT" => $arParams["LINE_ELEMENT_COUNT"],
                    "PRICE_CODE" => $arParams["PRICE_CODE"],
                    "USE_PRICE_COUNT" => $arParams["USE_PRICE_COUNT"],
                    "SHOW_PRICE_COUNT" => $arParams["SHOW_PRICE_COUNT"],

                    "PRICE_VAT_INCLUDE" => $arParams["PRICE_VAT_INCLUDE"],
                    "USE_PRODUCT_QUANTITY" => $arParams['USE_PRODUCT_QUANTITY'],
                    "ADD_PROPERTIES_TO_BASKET" => (isset($arParams["ADD_PROPERTIES_TO_BASKET"]) ? $arParams["ADD_PROPERTIES_TO_BASKET"] : ''),
                    "PARTIAL_PRODUCT_PROPERTIES" => (isset($arParams["PARTIAL_PRODUCT_PROPERTIES"]) ? $arParams["PARTIAL_PRODUCT_PROPERTIES"] : ''),
                    "PRODUCT_PROPERTIES" => $arParams["PRODUCT_PROPERTIES"],

                    "DISPLAY_TOP_PAGER" => 'N',
                    "DISPLAY_BOTTOM_PAGER" => 'N',
                    "PAGER_TITLE" => 'N',
                    "PAGER_SHOW_ALWAYS" => 'N',
                    "PAGER_TEMPLATE" => '',
                    "PAGER_DESC_NUMBERING" => 'N',
                    "PAGER_DESC_NUMBERING_CACHE_TIME" => '',
                    "PAGER_SHOW_ALL" => 'N',

                    "OFFERS_CART_PROPERTIES" => $arParams["OFFERS_CART_PROPERTIES"],
                    "OFFERS_FIELD_CODE" => $arParams["LIST_OFFERS_FIELD_CODE"],
                    "OFFERS_PROPERTY_CODE" => $arParams["LIST_OFFERS_PROPERTY_CODE"],
                    "OFFERS_SORT_FIELD" => $arParams["OFFERS_SORT_FIELD"],
                    "OFFERS_SORT_ORDER" => $arParams["OFFERS_SORT_ORDER"],
                    "OFFERS_SORT_FIELD2" => $arParams["OFFERS_SORT_FIELD2"],
                    "OFFERS_SORT_ORDER2" => $arParams["OFFERS_SORT_ORDER2"],
                    "OFFERS_LIMIT" => $arParams["LIST_OFFERS_LIMIT"],

                    //                "SECTION_ID" => $arResult["VARIABLES"]["SECTION_ID"],
                    //                "SECTION_CODE" => $arResult["VARIABLES"]["SECTION_CODE"],
                    "SECTION_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["section"],
                    "DETAIL_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["element"],
                    'CONVERT_CURRENCY' => $arParams['CONVERT_CURRENCY'],
                    'CURRENCY_ID' => $arParams['CURRENCY_ID'],
                    'HIDE_NOT_AVAILABLE' => $arParams["HIDE_NOT_AVAILABLE"],

                    'LABEL_PROP' => $arParams['LABEL_PROP'],
                    'ADD_PICT_PROP' => $arParams['ADD_PICT_PROP'],
                    'PRODUCT_DISPLAY_MODE' => $arParams['PRODUCT_DISPLAY_MODE'],

                    'OFFER_ADD_PICT_PROP' => $arParams['OFFER_ADD_PICT_PROP'],
                    'OFFER_TREE_PROPS' => $arParams['OFFER_TREE_PROPS'],
                    'PRODUCT_SUBSCRIPTION' => $arParams['PRODUCT_SUBSCRIPTION'],
                    'SHOW_DISCOUNT_PERCENT' => $arParams['SHOW_DISCOUNT_PERCENT'],
                    'SHOW_OLD_PRICE' => $arParams['SHOW_OLD_PRICE'],
                    'MESS_BTN_BUY' => $arParams['MESS_BTN_BUY'],
                    'MESS_BTN_ADD_TO_BASKET' => $arParams['MESS_BTN_ADD_TO_BASKET'],
                    'MESS_BTN_SUBSCRIBE' => $arParams['MESS_BTN_SUBSCRIBE'],
                    'MESS_BTN_DETAIL' => $arParams['MESS_BTN_DETAIL'],
                    'MESS_NOT_AVAILABLE' => $arParams['MESS_NOT_AVAILABLE'],

                    'TEMPLATE_THEME' => (isset($arParams['TEMPLATE_THEME']) ? $arParams['TEMPLATE_THEME'] : ''),
                    "ADD_SECTIONS_CHAIN" => "N",
                    'ADD_TO_BASKET_ACTION' => $basketAction,
                    'SHOW_CLOSE_POPUP' => isset($arParams['COMMON_SHOW_CLOSE_POPUP']) ? $arParams['COMMON_SHOW_CLOSE_POPUP'] : '',
                    'COMPARE_PATH' => $arResult['FOLDER'] . $arResult['URL_TEMPLATES']['compare'],
                    'LAZY_LOAD' => $arParams['LAZY_LOAD'],
                ),
                $component
            );
        }
        ?>
        <?

        $APPLICATION->IncludeComponent(
            "gt:catalog.section",
            "",
            array(
                "IBLOCK_TYPE" => $arParams["IBLOCK_TYPE"],
                "IBLOCK_ID" => $arParams["IBLOCK_ID"],
                "ELEMENT_SORT_FIELD" => $sort['SORT_BY'],
                "ELEMENT_SORT_ORDER" => $sort['SORT_ORDER'],
                "ELEMENT_SORT_FIELD2" => $arParams["ELEMENT_SORT_FIELD2"],
                "ELEMENT_SORT_ORDER2" => $arParams["ELEMENT_SORT_ORDER2"],
                "PROPERTY_CODE" => $arParams["LIST_PROPERTY_CODE"],
                "META_KEYWORDS" => $arParams["LIST_META_KEYWORDS"],
                "META_DESCRIPTION" => $arParams["LIST_META_DESCRIPTION"],
                "BROWSER_TITLE" => $arParams["LIST_BROWSER_TITLE"],
                "INCLUDE_SUBSECTIONS" => $arParams["INCLUDE_SUBSECTIONS"],
                "BASKET_URL" => $arParams["BASKET_URL"],
                "ACTION_VARIABLE" => $arParams["ACTION_VARIABLE"],
                "PRODUCT_ID_VARIABLE" => $arParams["PRODUCT_ID_VARIABLE"],
                "SECTION_ID_VARIABLE" => $arParams["SECTION_ID_VARIABLE"],
                "PRODUCT_QUANTITY_VARIABLE" => $arParams["PRODUCT_QUANTITY_VARIABLE"],
                "PRODUCT_PROPS_VARIABLE" => $arParams["PRODUCT_PROPS_VARIABLE"],
                "FILTER_NAME" => $arParams["FILTER_NAME"],
                //"FILTER_NAL" => ${$arParams['FILTER_NAME']},
                "CACHE_TYPE" => $arParams["CACHE_TYPE"],
                "CACHE_TIME" => $arParams["CACHE_TIME"],
                "CACHE_FILTER" => $arParams["CACHE_FILTER"],
                "CACHE_GROUPS" => $arParams["CACHE_GROUPS"],
                "SET_TITLE" => $arParams["SET_TITLE"],
                "SET_STATUS_404" => $arParams["SET_STATUS_404"],
                "DISPLAY_COMPARE" => $arParams["USE_COMPARE"],
                "PAGE_ELEMENT_COUNT" => $arParams["PAGE_ELEMENT_COUNT"],
                "LINE_ELEMENT_COUNT" => $arParams["LINE_ELEMENT_COUNT"],
                "PRICE_CODE" => $arParams["PRICE_CODE"],
                "USE_PRICE_COUNT" => $arParams["USE_PRICE_COUNT"],
                "SHOW_PRICE_COUNT" => $arParams["SHOW_PRICE_COUNT"],
                "PRICE_VAT_INCLUDE" => $arParams["PRICE_VAT_INCLUDE"],
                "USE_PRODUCT_QUANTITY" => $arParams['USE_PRODUCT_QUANTITY'],
                "ADD_PROPERTIES_TO_BASKET" => (isset($arParams["ADD_PROPERTIES_TO_BASKET"]) ? $arParams["ADD_PROPERTIES_TO_BASKET"] : ''),
                "PARTIAL_PRODUCT_PROPERTIES" => (isset($arParams["PARTIAL_PRODUCT_PROPERTIES"]) ? $arParams["PARTIAL_PRODUCT_PROPERTIES"] : ''),
                "PRODUCT_PROPERTIES" => $arParams["PRODUCT_PROPERTIES"],
                "DISPLAY_TOP_PAGER" => $arParams["DISPLAY_TOP_PAGER"],
                "DISPLAY_BOTTOM_PAGER" => $arParams["DISPLAY_BOTTOM_PAGER"],
                "PAGER_TITLE" => $arParams["PAGER_TITLE"],
                "PAGER_SHOW_ALWAYS" => $arParams["PAGER_SHOW_ALWAYS"],
                "PAGER_TEMPLATE" => $arParams["PAGER_TEMPLATE"],
                "PAGER_DESC_NUMBERING" => $arParams["PAGER_DESC_NUMBERING"],
                "PAGER_DESC_NUMBERING_CACHE_TIME" => $arParams["PAGER_DESC_NUMBERING_CACHE_TIME"],
                "PAGER_SHOW_ALL" => $arParams["PAGER_SHOW_ALL"],
                "OFFERS_CART_PROPERTIES" => $arParams["OFFERS_CART_PROPERTIES"],
                "OFFERS_FIELD_CODE" => $arParams["LIST_OFFERS_FIELD_CODE"],
                "OFFERS_PROPERTY_CODE" => $arParams["LIST_OFFERS_PROPERTY_CODE"],
                "OFFERS_SORT_FIELD" => $arParams["OFFERS_SORT_FIELD"],
                "OFFERS_SORT_ORDER" => $arParams["OFFERS_SORT_ORDER"],
                "OFFERS_SORT_FIELD2" => $arParams["OFFERS_SORT_FIELD2"],
                "OFFERS_SORT_ORDER2" => $arParams["OFFERS_SORT_ORDER2"],
                "OFFERS_LIMIT" => $arParams["LIST_OFFERS_LIMIT"],
                "SECTION_ID" => $arResult["VARIABLES"]["SECTION_ID"],
                "SECTION_CODE" => $arResult["VARIABLES"]["SECTION_CODE"],
                "SECTION_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["section"],
                "DETAIL_URL" => $arResult["FOLDER"] . $arResult["URL_TEMPLATES"]["element"],
                'CONVERT_CURRENCY' => $arParams['CONVERT_CURRENCY'],
                'CURRENCY_ID' => $arParams['CURRENCY_ID'],
                'HIDE_NOT_AVAILABLE' => $arParams["HIDE_NOT_AVAILABLE"],
                'LABEL_PROP' => $arParams['LABEL_PROP'],
                'ADD_PICT_PROP' => $arParams['ADD_PICT_PROP'],
                'PRODUCT_DISPLAY_MODE' => $arParams['PRODUCT_DISPLAY_MODE'],
                'OFFER_ADD_PICT_PROP' => $arParams['OFFER_ADD_PICT_PROP'],
                'OFFER_TREE_PROPS' => $arParams['OFFER_TREE_PROPS'],
                'PRODUCT_SUBSCRIPTION' => $arParams['PRODUCT_SUBSCRIPTION'],
                'SHOW_DISCOUNT_PERCENT' => $arParams['SHOW_DISCOUNT_PERCENT'],
                'SHOW_OLD_PRICE' => $arParams['SHOW_OLD_PRICE'],
                'MESS_BTN_BUY' => $arParams['MESS_BTN_BUY'],
                'MESS_BTN_ADD_TO_BASKET' => $arParams['MESS_BTN_ADD_TO_BASKET'],
                'MESS_BTN_SUBSCRIBE' => $arParams['MESS_BTN_SUBSCRIBE'],
                'MESS_BTN_DETAIL' => $arParams['MESS_BTN_DETAIL'],
                'MESS_NOT_AVAILABLE' => $arParams['MESS_NOT_AVAILABLE'],
                'TEMPLATE_THEME' => (isset($arParams['TEMPLATE_THEME']) ? $arParams['TEMPLATE_THEME'] : ''),
                "ADD_SECTIONS_CHAIN" => "N",
                'ADD_TO_BASKET_ACTION' => $basketAction,
                'SHOW_CLOSE_POPUP' => isset($arParams['COMMON_SHOW_CLOSE_POPUP']) ? $arParams['COMMON_SHOW_CLOSE_POPUP'] : '',
                'COMPARE_PATH' => $arResult['FOLDER'] . $arResult['URL_TEMPLATES']['compare'],
                'HIDE_PROPERTIES' => $arParams['DETAIL_HIDE_PROPERTIES'],
                'LAZY_LOAD' => $arParams['LAZY_LOAD'],
            ),
            $component
        ); ?>
        <br/>
        <div>
            <?
            $request_string = $APPLICATION->GetCurPageParam();

            if (strpos($request_string, "PAGEN_") === false) {
                echo '<!--start_content-->';
global $sotbitSeoMetaBottomDesc;
global $sotbitSeoMetaTitle;
global $sotbitSeoMetaH1;  

if((!empty($sotbitSeoMetaBottomDesc)) or (!empty($sotbitSeoMetaTitle)) or (!empty($sotbitSeoMetaH1)) or (strpos($APPLICATION->GetCurPage(), 'filter'))){
echo $sotbitSeoMetaBottomDesc;

}else{
//вывод верхнего описания
echo $uf_value["DESCRIPTION"];
 if ($uf_value["UF_METKI"])
 {
    ?>
        <style type="text/css">
            .tags {
                box-sizing: border-box;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 2px;
                margin: 20px 0;
            }
            .tags-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            .tags ul {
                padding-left: 0;
                list-style: none;
                margin-left: 0;
            }
            .tags ul li {
                display: inline-block;
                padding: 2px;
            }
            .tags ul > span {
                font-style: italic;
                margin-right: 10px;
            }
            .tags ul li > a {
                margin-right: 10px;
            }
            #hidden-tags {
                display: none;
            }
            .tags-showhidden {
                text-align: right;
                cursor: pointer;
            }
        </style>

        <div class="tags">
        <div class="tags-title">Популярные метки</div>
                <? echo html_entity_decode($uf_value["UF_METKI"]); ?>
        <div class="tags-showhidden" onclick="document.getElementById('hidden-tags').style.display='block';$(this).fadeOut();">Популярные метки</div>
        </div>

    <?
 }
}


				//echo $uf_value["DESCRIPTION"];
                echo '<!--end_content-->';
            }

            ?>
        </div>
    </div>
</div>

<?
if (!empty($menu_sections['TITLE'])) {
    $APPLICATION->AddChainItem($menu_sections['TITLE'], $arResult['FOLDER'] . $arResult['VARIABLES']['VIRTYAL'] . '/');
    foreach ($menu_sections['SECTIONS'] as $arSection) {
        if ($arSection['ACTIV']) {
            $APPLICATION->SetTitle($arSection['NAME']);
            $APPLICATION->AddChainItem($arSection['NAME']);
            break;
        } else {
            foreach ($arSection['SUBSEC'] as $arSubsection) {
                if ($arSubsection['ACTIV']) {
                    $APPLICATION->SetTitle($arSubsection['NAME']);
                    $APPLICATION->AddChainItem($arSubsection['NAME']);
                    break;
                }
            }
        }
    }
}

$ipropValues = new \Bitrix\Iblock\InheritedProperty\SectionValues($arParams["IBLOCK_ID"], $sectID);
$metaSeo["IPROPERTY_VALUES"] = $ipropValues->getValues();

if ($metaSeo["IPROPERTY_VALUES"]["SECTION_META_DESCRIPTION"]) {
    $APPLICATION->SetPageProperty("description", $metaSeo["IPROPERTY_VALUES"]["SECTION_META_DESCRIPTION"]);
}
if ($metaSeo["IPROPERTY_VALUES"]["SECTION_META_TITLE"]) {
    $APPLICATION->SetPageProperty("title", $metaSeo["IPROPERTY_VALUES"]["SECTION_META_TITLE"]);
}
?>
<?



	global $sotbitSeoMetaTitle;
	global $sotbitSeoMetaKeywords;
	global $sotbitSeoMetaDescription;
	global $sotbitSeoMetaBreadcrumbTitle;
	global $sotbitSeoMetaH1;  
	if(!empty($sotbitSeoMetaH1)){
		 $APPLICATION->SetTitle($sotbitSeoMetaH1); 
	} 
	if(!empty($sotbitSeoMetaTitle)){
		$APPLICATION->SetPageProperty("title", $sotbitSeoMetaTitle);
	}
	if(!empty($sotbitSeoMetaKeywords)){
		$APPLICATION->SetPageProperty("keywords", $sotbitSeoMetaKeywords);
	}
	if(!empty($sotbitSeoMetaDescription)){
		$APPLICATION->SetPageProperty("description", $sotbitSeoMetaDescription);
	} 
	if(!empty($sotbitSeoMetaBreadcrumbTitle)){
		$APPLICATION->AddChainItem($sotbitSeoMetaBreadcrumbTitle);

	}


$sectID = getIdByCode($arResult["VARIABLES"]["SECTION_CODE"], $arParams["IBLOCK_ID"], "IBLOCK_SECTION");
$arFilter = Array('IBLOCK_ID' => $arParams['IBLOCK_ID'], 'ID' => $sectID, 'GLOBAL_ACTIVE' => 'Y');
$db_list = CIBlockSection::GetList(Array("timestamp_x" => "DESC"), $arFilter, false,
    Array("UF_SEO_H1", "UF_DESCRIPTION", "UF_METKI"));
if ($uf_value = $db_list->GetNext()) {
    $h1 = $uf_value["UF_SEO_H1"];
    $APPLICATION->SetTitle($h1);
}

?>

